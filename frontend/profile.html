<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DoseMate — Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ... (all your previous CSS here) ... */
  </style>
</head>
<body>
  <div class="shell" role="main" aria-labelledby="mainheading">
    <div class="left" aria-hidden="false">
      <div class="logo"><div class="pill">DM</div>DoseMate</div>
      <div class="tag">Your smart medicine companion — schedule reminders, manage refills and never miss a dose.</div>
      <div class="left-illus" aria-hidden="true"></div>
    </div>

    <div class="right">
      <div class="card" role="form" aria-labelledby="formheading">
        <div class="toggle" role="tablist" aria-label="Login type">
          <button id="toggle-user" class="active" role="tab" aria-selected="true">User</button>
          <button id="toggle-admin" role="tab" aria-selected="false">Admin</button>
        </div>

        <div id="login-area">
          <div class="title" id="formheading">Welcome back</div>
          <div class="subtitle" id="subtitle">Login to continue</div>

          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" autocomplete="current-password" />
          </div>

          <button id="loginBtn" class="primary" aria-live="polite">Login</button>

          <div class="low">
            New user? <span id="openSignup" class="link">Sign up</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <button class="close-btn" id="closeModal" aria-label="Close signup">✕</button>
      <h3 style="margin-top:6px;margin-bottom:8px">Create new account</h3>
      <p style="margin:0 0 14px;color:var(--muted)">Sign up as a DoseMate user. Admins are created on the server.</p>

      <div class="row">
        <div>
          <label for="signupName">Full name</label>
          <input id="signupName" type="text" autocomplete="name" />
        </div>
        <div>
          <label for="signupPhone">Phone</label>
          <input id="signupPhone" type="text" inputmode="tel" placeholder="+91XXXXXXXXXX"/>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="signupEmail">Email</label>
        <input id="signupEmail" type="email" autocomplete="email" />
      </div>

      <div style="margin-top:12px">
        <label for="signupPassword">Password</label>
        <input id="signupPassword" type="password" autocomplete="new-password" />
      </div>

      <div style="margin-top:14px; display:flex; gap:10px;">
        <button id="signupBtn" class="primary">Create account</button>
        <button id="cancelSignup" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const BASE_URL = "https://medicinereminder-4vsg.onrender.com/api";

// UI refs
const btnUser = document.getElementById('toggle-user');
const btnAdmin = document.getElementById('toggle-admin');
const loginBtn = document.getElementById('loginBtn');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const subtitle = document.getElementById('subtitle');

const modalBackdrop = document.getElementById('modalBackdrop');
const openSignup = document.getElementById('openSignup');
const closeModal = document.getElementById('closeModal');
const cancelSignup = document.getElementById('cancelSignup');
const signupBtn = document.getElementById('signupBtn');

const signupName = document.getElementById('signupName');
const signupPhone = document.getElementById('signupPhone');
const signupEmail = document.getElementById('signupEmail');
const signupPassword = document.getElementById('signupPassword');

const toast = document.getElementById('toast');

let currentRole = 'user'; // 'user' or 'admin'

// Helpers
function showToast(message, options = {}) {
  const { loading=false, duration=2500 } = options;
  toast.innerHTML = '';
  if (loading) {
    const loader = document.createElement('span');
    loader.className = 'loader';
    toast.appendChild(loader);
    const txt = document.createElement('span'); txt.textContent = ' ' + message;
    toast.appendChild(txt);
    toast.classList.add('show');
    return;
  }
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), duration);
}

function setToggle(role) {
  currentRole = role;
  if (role === 'user') {
    btnUser.classList.add('active'); btnAdmin.classList.remove('active');
    subtitle.textContent = "Login to your DoseMate account";
  } else {
    btnAdmin.classList.add('active'); btnUser.classList.remove('active');
    subtitle.textContent = "Admin panel login";
  }
}

// Toggle buttons
btnUser.addEventListener('click', ()=> setToggle('user'));
btnAdmin.addEventListener('click', ()=> setToggle('admin'));

// Modal open/close
openSignup.addEventListener('click', ()=> {
  modalBackdrop.style.display = 'flex';
  modalBackdrop.setAttribute('aria-hidden', 'false');
  signupName.focus();
});
function closeSignupModal() {
  modalBackdrop.style.display = 'none';
  modalBackdrop.setAttribute('aria-hidden', 'true');
}
closeModal.addEventListener('click', closeSignupModal);
cancelSignup.addEventListener('click', closeSignupModal);
modalBackdrop.addEventListener('click', (e)=> { if(e.target===modalBackdrop) closeSignupModal(); });

// Network helpers
async function postJSON(url, body) {
  showToast('Please wait...', {loading:true});
  try {
    const res = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Server error');
    showToast('Done', {duration:900});
    return data;
  } catch (err) {
    showToast(err.message || 'Network error', {duration:4000});
    throw err;
  }
}

// Login
loginBtn.addEventListener('click', async ()=> {
  const email = loginEmail.value.trim();
  const password = loginPassword.value;
  if (!email || !password) { showToast('Fill email & password'); return; }

  try {
    showToast('Signing in...', {loading:true});
    const data = await postJSON(`${BASE_URL}/auth/login`, { email, password });

    if (currentRole === 'user' && data.role !== 'user') { showToast('This is an admin account — use Admin login.', {duration:4000}); return; }
    if (currentRole === 'admin' && data.role !== 'admin') { showToast('This is a user account — use User login.', {duration:4000}); return; }

    // ✅ Save token & phone
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role);
    if (data.phone) localStorage.setItem('phone', data.phone);

    showToast("Login successful!", {duration:900});
    setTimeout(()=> {
      if (data.role==='admin') window.location.href='admin.html';
      else window.location.href='dashboard.html';
    }, 900);

  } catch(err){ }
});

// Signup
signupBtn.addEventListener('click', async ()=> {
  const name = signupName.value.trim();
  let phone = signupPhone.value.trim();
  const email = signupEmail.value.trim();
  const password = signupPassword.value;

  if (!name || !phone || !email || !password) { showToast('Fill all fields'); return; }
  if (!phone.startsWith('+')) phone = `+91${phone}`;

  try {
    await postJSON(`${BASE_URL}/auth/register`, { name, phone, email, password, role:'user' });
    localStorage.setItem('phone', phone); // ✅ save phone locally
    showToast('Signup successful! Please login.', {duration:2500});
    signupName.value=''; signupPhone.value=''; signupEmail.value=''; signupPassword.value='';
    setTimeout(()=> { closeSignupModal(); setToggle('user'); loginEmail.value=email; loginPassword.value=''; loginEmail.focus(); }, 900);
  } catch(err){ }
});
</script>
</body>
</html>
